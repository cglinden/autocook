/*  cook files look like -*- C++ -*-
 *
 *  Autodiscovering Build System
 *  Copyright (C) 1997 - 2002 CG Software Design LLC
 *
 *  This program is free software; you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation; either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 *
 *  Please send bug reports to bugs@cg-soft.com
 */

/*==============================================================*
 *								*
 *	RPM build: provide a target to cascade from		*
 *								*
 *==============================================================*/

/*--- create rpm target ----------------------------------------*/
%0[do]/[unix]/%9/%[rpmbuild_suffix]: %0[do]/[unix]/%9/spec/%[spec_suffix]:
    /* Uncomment next line if a change here should trigger rebuilds */
    [build]/include/rules/phase_6/rpm
    [cookbook]
    [get use_dependency %9 %0]
    [get-local-value customized_in %0]
  set silent
  if [in [target_in_%0%9] rpm]
  single-thread sub_build
{
#include [build]/include/rules/store-prerequisites
  [cat] > [target][how_suffix];
data
#!/bin/sh

# Script generated by rule defined in:
# [__FILE__]\:[__LINE__]

[trace rpmbuild %0 %9]
[trace rpmbuild_flags %0 %9]

cd [pwd];

[echo] "'    RPM build:   '"%0[do]/[unix]/%9/spec/%[spec_suffix]"' -> ("[thread-id]")'";
[rmdir] %0[do]/[unix]/%9/%/RPMS %0[do]/[unix]/%9/%/BUILD;
[mkdir] %0[do]/[unix]/%9/%/RPMS %0[do]/[unix]/%9/%/BUILD;
 
[rm] [target]
if test x[defined frozen_[unix]/%9_rpm_%] != x
then
  [echo] "'--- Skipping rebuild of frozen % RPM'"
  exit 0
fi

# Do -not- change the order without changing the logic in the .spec files
# Unstripped must be packed first simply because I am reusing the same
# copy of the runtime for both styles

# add 'stripped' below if stripped rpms are to ever be built
for style in unstripped 
do
  echo '"====[$style]===="' >>[target]
  [get rpmbuild %0 %9]\\
    [get rpmbuild_flags %0 %9]\\
    --define "'_build_name_fmt %%%%{NAME}-%%%%{VERSION}-%%%%{RELEASE}.rpm'"\\
    --define "'_topdir "[pwd]"/%0"[do]"/"[unix]"/%9/%'"\\
    --define "'_rpmlock_path "[pwd]"/runtime/rpmdb/__db.000'"\\
    --define "'cook_top "[pwd]"'"\\
    --define "'cook_runtime "[pwd]/runtime/%9"'"\\
    --define "'variant "%9"'"\\
    --define "'style '$style"\\
    --define "'platform "[unix]"'"\\
    %0[do]/[unix]/%9/spec/%[spec_suffix]\\
    >>[target]\\
    2>&1\\
  && [rm] %0%-%9-$style-*.rpm\\
  && ( cd %0. && [ln] [do]/[unix]/%9/%/RPMS/%-%9-$style-*.rpm . )\\
  || ( [cat] [target] >&2 && [rm] [target] %0%-%9-$style-*.rpm\; exit 1 );
done
dataend
  [run-build-script [target]];
}

/*--- install frozen rpm ---------------------------------------*/
%0[do]/[unix]/%9/%[rpminstall_suffix]: [frozen_noarch/%9_rpm_%]
    /* Uncomment next line if a change here should trigger rebuilds */
    [build]/include/rules/phase_6/rpm
    [cookbook]
    [get use_dependency %9 %0]
    [get-local-value customized_in %0]
  set silent mkdir
  if [and [in [target_in_%0%9] rpm] [defined frozen_noarch/%9_rpm_%]]
  single-thread rpm
{
#include [build]/include/rules/store-prerequisites
  [cat] > [target][how_suffix];
data
#!/bin/sh

# Script generated by rule defined in:
# [__FILE__]\:[__LINE__]

cd [pwd]

[echo] "'    Frozen RPM:  '"[frozen_noarch/%9_rpm_%] "'-> ("[thread-id]")'";
[mkdir] runtime/rpmdb;
( rpm -Uvv\\
   --prefix [pwd]/runtime/%9\\
   --dbpath [pwd]/runtime/rpmdb\\
   --define "'_rpmlock_path "[pwd]"/runtime/rpmdb/__db.000'"\\
   --nodeps\\
   --force\\
   [pwd]/[frozen_noarch/%9_rpm_%]\\
   >[target]\\
   2>&1 )\\
|| ( [cat] [target] >&2 && [rm] [target]\; false );
dataend
  [run-build-script [target]];
}

/*--- install frozen rpm ---------------------------------------*/
%0[do]/[unix]/%9/%[rpminstall_suffix]: [frozen_[unix]/%9_rpm_%]
    /* Uncomment next line if a change here should trigger rebuilds */
    [build]/include/rules/phase_6/rpm
    [cookbook]
    [get use_dependency %9 %0]
    [get-local-value customized_in %0]
  set silent mkdir
  if [and [in [target_in_%0%9] rpm] [defined frozen_[unix]/%9_rpm_%]]
  single-thread rpm
{
#include [build]/include/rules/store-prerequisites
  [cat] > [target][how_suffix];
data
#!/bin/sh

# Script generated by rule defined in:
# [__FILE__]\:[__LINE__]

cd [pwd]

[echo] "'    Frozen RPM:  '"[frozen_[unix]/%9_rpm_%] "'-> ("[thread-id]")'";
[mkdir] runtime/rpmdb;
( rpm -Uvv\\
   --prefix [pwd]/runtime/%9\\
   --dbpath [pwd]/runtime/rpmdb\\
   --define "'_rpmlock_path "[pwd]"/runtime/rpmdb/__db.000'"\\
   --nodeps\\
   --force\\
   [pwd]/[frozen_[unix]/%9_rpm_%]\\
   >[target]\\
   2>&1 )\\
|| ( [cat] [target] >&2 && [rm] [target]\; false );
dataend
  [run-build-script [target]];
}

/*--- install rpm -----------------------------------------------*/
%0[do]/[unix]/%9/%[rpminstall_suffix]: %0[do]/[unix]/%9/%[rpmbuild_suffix]
    /* Uncomment next line if a change here should trigger rebuilds  */
    [build]/include/rules/phase_6/rpm
    [cookbook]
    [get use_dependency %9 %0]
    [get-local-value customized_in %0]
  set silent mkdir
  if [and [in [target_in_%0%9] rpm] [not [defined frozen_[unix]/%9_rpm_%]] [not [defined frozen_noarch/%9_rpm_%]]]
  single-thread rpm
{
#include [build]/include/rules/store-prerequisites
  [cat] > [target][how_suffix];
data
#!/bin/sh

# Script generated by rule defined in:
# [__FILE__]\:[__LINE__]

cd [pwd]

[echo] "'    Install RPM:'" %0[do]/[unix]/%9/%'/RPMS/'*-unstripped-*.rpm  "'-> ("[thread-id]")'";

[mkdir] runtime/rpmdb;
( rpm -Uvv\\
    --prefix [pwd]/runtime/%9\\
    --dbpath [pwd]/runtime/rpmdb\\
    --define "'_rpmlock_path "[pwd]"/runtime/rpmdb/__db.000'"\\
    --nodeps\\
    --force\\
    %0[do]/[unix]/%9/%'/RPMS/'*-unstripped-*.rpm\\
   >[target]\\
   2>&1 )\\
|| ( [cat] [target] >&2 && [rm] [target]\; false );
dataend
  [run-build-script [target]];
}

;
